<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPC Lead Finder - Cucumber Eco</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-white to-green-50 min-h-screen">
    <div id="app">
        <!-- Header -->
        <div class="bg-white border-b shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                <div class="flex items-center space-x-3">
                    <div class="bg-blue-600 p-2 rounded-lg">
                        <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10"></circle>
                            <circle cx="12" cy="12" r="6"></circle>
                            <circle cx="12" cy="12" r="2"></circle>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">EPC Lead Finder</h1>
                        <p class="text-sm text-gray-600">Find properties needing energy improvements</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Search Form -->
            <div class="bg-white rounded-lg shadow-sm border p-6 mb-8">
                <h2 class="text-lg font-semibold mb-4 flex items-center">
                    <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M21 21l-4.35-4.35M11 19a8 8 0 100-16 8 8 0 000 16z"></path>
                    </svg>
                    Search Criteria
                </h2>
                
                <div class="space-y-4">
                    <!-- Search Input -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium mb-2">Search Area</label>
                            <input type="text" id="searchTerm" 
                                   placeholder="e.g., M1, L1, Manchester, Liverpool"
                                   class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Search Type</label>
                            <select id="searchType" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="postcode">Postcode Area (e.g., M1)</option>
                                <option value="address">Town/City Name</option>
                            </select>
                        </div>
                    </div>

                    <!-- EPC Ratings -->
                    <div>
                        <label class="block text-sm font-medium mb-2">Target EPC Ratings</label>
                        <p class="text-sm text-gray-600 mb-2">Select ratings of properties needing improvements</p>
                        <div class="flex flex-wrap gap-2" id="ratingButtons">
                            <button data-rating="A" class="px-3 py-1 border rounded-md hover:bg-gray-100">A</button>
                            <button data-rating="B" class="px-3 py-1 border rounded-md hover:bg-gray-100">B</button>
                            <button data-rating="C" class="px-3 py-1 border rounded-md hover:bg-gray-100">C</button>
                            <button data-rating="D" class="px-3 py-1 border rounded-md bg-yellow-500 text-white">D</button>
                            <button data-rating="E" class="px-3 py-1 border rounded-md bg-orange-500 text-white">E</button>
                            <button data-rating="F" class="px-3 py-1 border rounded-md bg-red-500 text-white">F</button>
                            <button data-rating="G" class="px-3 py-1 border rounded-md hover:bg-gray-100">G</button>
                        </div>
                    </div>

                    <!-- Tenure Type -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Target Market</label>
                            <select id="tenureType" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="private-rental">üéØ Private Rentals (Landlords)</option>
                                <option value="social-housing">üè¢ Social Housing</option>
                                <option value="all-rental">üè† All Rentals</option>
                                <option value="owner-occupied">üë§ Owner-Occupied</option>
                                <option value="all">üìä All Properties</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Results Limit</label>
                            <input type="number" id="resultLimit" value="100" min="10" max="500"
                                   class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <!-- Search Button -->
                    <div class="flex justify-center mt-6">
                        <button id="searchBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-2 rounded-md flex items-center">
                            <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path d="M21 21l-4.35-4.35M11 19a8 8 0 100-16 8 8 0 000 16z"></path>
                            </svg>
                            Find Leads
                        </button>
                    </div>
                </div>
            </div>

            <!-- Error Message -->
            <div id="errorMsg" class="hidden bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-md mb-4"></div>

            <!-- Results -->
            <div id="results" class="hidden">
                <div class="bg-white rounded-lg shadow-sm border">
                    <div class="bg-gradient-to-r from-blue-50 to-green-50 p-6 rounded-t-lg">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-lg font-semibold">Lead Generation Results</h3>
                                <p id="resultMsg" class="text-sm text-gray-600 mt-1"></p>
                            </div>
                            <button id="exportBtn" class="bg-white px-4 py-2 rounded-md border hover:bg-gray-50 text-sm">
                                üì• Export CSV
                            </button>
                        </div>
                        
                        <!-- Stats -->
                        <div id="stats" class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4"></div>
                    </div>
                    
                    <!-- Results Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-semibold">Score</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold">Property Details</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold">EPC</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold">Type & Tenure</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold">Costs & Date</th>
                                </tr>
                            </thead>
                            <tbody id="resultsBody" class="divide-y"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Token
        const API_TOKEN = 'bGVlLmhheXRvbkBhZGFwdGl4aW5ub3ZhdGlvbi5jby51azplMjMwNjdjZTJkMGE2MjdlZmQ3NDg3NDhkYzMzOWExYWM2ZTZlN2Vm';
        
        // State
        let selectedRatings = ['D', 'E', 'F'];
        let searchResults = [];
        
        // Initialize rating buttons
        document.querySelectorAll('#ratingButtons button').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const rating = e.target.dataset.rating;
                if (selectedRatings.includes(rating)) {
                    selectedRatings = selectedRatings.filter(r => r !== rating);
                    e.target.classList.remove('bg-green-500', 'bg-yellow-500', 'bg-orange-500', 'bg-red-500', 'text-white');
                    e.target.classList.add('hover:bg-gray-100');
                } else {
                    selectedRatings.push(rating);
                    const colors = {
                        'A': 'bg-green-500', 'B': 'bg-green-500', 'C': 'bg-green-400',
                        'D': 'bg-yellow-500', 'E': 'bg-orange-500', 'F': 'bg-red-500', 'G': 'bg-red-500'
                    };
                    e.target.classList.add(colors[rating], 'text-white');
                    e.target.classList.remove('hover:bg-gray-100');
                }
            });
        });
        
        // Calculate lead score
        function calculateLeadScore(property) {
            let score = 0;
            const rating = property['current-energy-rating'] || 'G';
            const ratingScores = {'A': 1, 'B': 2, 'C': 3, 'D': 4, 'E': 5, 'F': 6, 'G': 7};
            score += ratingScores[rating] || 0;
            
            if (property.tenure === 'Rented (private)') score += 3;
            if (property['lodgement-date'] >= '2023-01-01') score += 2;
            
            const heatingCost = parseFloat(property['heating-cost-current'] || '0');
            if (heatingCost > 800) score += 2;
            else if (heatingCost > 500) score += 1;
            
            return score;
        }
        
        // Parse CSV
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length === 0) return [];
            
            const headers = lines[0].split(',');
            const results = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = values[index] || '';
                });
                results.push(obj);
            }
            
            return results;
        }
        
        // Get tenure filter
        function getTenureFilter() {
            const tenureType = document.getElementById('tenureType').value;
            switch (tenureType) {
                case 'private-rental': return ['Rented (private)'];
                case 'social-housing': return ['Rented (social)'];
                case 'all-rental': return ['Rented (private)', 'Rented (social)'];
                case 'owner-occupied': return ['Owner-occupied'];
                case 'all': return null;
                default: return ['Rented (private)'];
            }
        }
        
        // Search function
        async function search() {
            const searchTerm = document.getElementById('searchTerm').value.trim();
            const searchType = document.getElementById('searchType').value;
            const resultLimit = parseInt(document.getElementById('resultLimit').value);
            
            if (!searchTerm || selectedRatings.length === 0) {
                showError('Please enter a search term and select at least one EPC rating');
                return;
            }
            
            // Show loading
            document.getElementById('searchBtn').innerHTML = '<div class="spinner mr-2"></div> Searching...';
            document.getElementById('searchBtn').disabled = true;
            hideError();
            hideResults();
            
            try {
                const baseUrl = 'https://epc.opendatacommunities.org/api/v1/domestic/search';
                const params = new URLSearchParams();
                
                if (searchType === 'postcode') {
                    params.append('postcode', searchTerm);
                } else {
                    params.append('address', searchTerm);
                }
                
                const response = await fetch(`${baseUrl}?${params}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'text/csv',
                        'Authorization': `Basic ${API_TOKEN}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                const csvData = await response.text();
                
                if (!csvData.trim()) {
                    showResults([], 0);
                    return;
                }
                
                // Parse and filter results
                const allProperties = parseCSV(csvData);
                const filteredResults = [];
                let totalChecked = 0;
                const tenureFilter = getTenureFilter();
                
                for (const property of allProperties) {
                    totalChecked++;
                    
                    const currentRating = property['current-energy-rating']?.trim();
                    if (!currentRating || !selectedRatings.includes(currentRating)) continue;
                    
                    if (tenureFilter) {
                        const rowTenure = property.tenure?.trim();
                        if (!rowTenure || !tenureFilter.includes(rowTenure)) continue;
                    }
                    
                    property.leadScore = calculateLeadScore(property);
                    filteredResults.push(property);
                    
                    if (filteredResults.length >= resultLimit) break;
                }
                
                // Sort by lead score
                filteredResults.sort((a, b) => (b.leadScore || 0) - (a.leadScore || 0));
                searchResults = filteredResults;
                showResults(filteredResults, totalChecked);
                
            } catch (error) {
                showError(error.message);
            } finally {
                document.getElementById('searchBtn').innerHTML = '<svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 21l-4.35-4.35M11 19a8 8 0 100-16 8 8 0 000 16z"></path></svg>Find Leads';
                document.getElementById('searchBtn').disabled = false;
            }
        }
        
        // Show error
        function showError(message) {
            const errorDiv = document.getElementById('errorMsg');
            errorDiv.textContent = `Error: ${message}`;
            errorDiv.classList.remove('hidden');
        }
        
        function hideError() {
            document.getElementById('errorMsg').classList.add('hidden');
        }
        
        function hideResults() {
            document.getElementById('results').classList.add('hidden');
        }
        
        // Show results
        function showResults(results, totalChecked) {
            document.getElementById('results').classList.remove('hidden');
            document.getElementById('resultMsg').textContent = `Found ${results.length} matching properties from ${totalChecked} checked`;
            
            // Stats
            const privateRentals = results.filter(p => p.tenure === 'Rented (private)').length;
            const avgHeating = results.length > 0 ? 
                Math.round(results.reduce((acc, p) => acc + parseFloat(p['heating-cost-current'] || '0'), 0) / results.length) : 0;
            const avgScore = results.length > 0 ? 
                (results.reduce((acc, p) => acc + (p.leadScore || 0), 0) / results.length).toFixed(1) : 0;
            
            document.getElementById('stats').innerHTML = `
                <div class="bg-white rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-blue-600">${results.length}</div>
                    <div class="text-sm text-gray-600">Total Leads</div>
                </div>
                <div class="bg-white rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-green-600">${privateRentals}</div>
                    <div class="text-sm text-gray-600">Private Rentals</div>
                </div>
                <div class="bg-white rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-orange-600">¬£${avgHeating}</div>
                    <div class="text-sm text-gray-600">Avg Heating Cost</div>
                </div>
                <div class="bg-white rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-purple-600">${avgScore}</div>
                    <div class="text-sm text-gray-600">Avg Lead Score</div>
                </div>
            `;
            
            // Table
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';
            
            results.slice(0, 50).forEach(property => {
                const row = tbody.insertRow();
                
                // Score
                const scoreColor = property.leadScore >= 12 ? 'bg-red-100 text-red-800' :
                                 property.leadScore >= 8 ? 'bg-orange-100 text-orange-800' :
                                 'bg-green-100 text-green-800';
                row.insertCell().innerHTML = `<span class="px-2 py-1 rounded-md text-sm font-bold ${scoreColor}">${property.leadScore}/15</span>`;
                
                // Address
                const address = [property.address1, property.address2, property.address3].filter(Boolean).join(', ') || 'N/A';
                row.insertCell().innerHTML = `
                    <div class="text-sm font-medium">${address}</div>
                    <div class="text-xs text-gray-500">üìç ${property.postcode} ${property.posttown ? '‚Ä¢ ' + property.posttown : ''}</div>
                `;
                
                // EPC
                const ratingColors = {
                    'A': 'bg-green-500', 'B': 'bg-green-500', 'C': 'bg-green-400',
                    'D': 'bg-yellow-500', 'E': 'bg-orange-500', 'F': 'bg-red-500', 'G': 'bg-red-500'
                };
                const rating = property['current-energy-rating'] || 'N/A';
                row.insertCell().innerHTML = `
                    <span class="px-2 py-1 rounded-md text-white text-sm font-bold ${ratingColors[rating] || 'bg-gray-500'}">${rating}</span>
                    <div class="text-xs text-gray-500">Score: ${property['current-energy-efficiency'] || 'N/A'}</div>
                `;
                
                // Type & Tenure
                const tenureColor = property.tenure === 'Rented (private)' ? 'border-green-500 text-green-700' :
                                  property.tenure === 'Rented (social)' ? 'border-blue-500 text-blue-700' :
                                  'border-gray-500 text-gray-700';
                row.insertCell().innerHTML = `
                    <div class="text-sm">${property['property-type'] || 'N/A'}</div>
                    <div class="text-xs text-gray-500">${property['built-form'] || 'N/A'}</div>
                    <span class="inline-block mt-1 px-2 py-0.5 border rounded text-xs ${tenureColor}">${property.tenure || 'N/A'}</span>
                `;
                
                // Costs & Date
                row.insertCell().innerHTML = `
                    <div class="text-sm">üí∑ ¬£${property['heating-cost-current'] || 'N/A'}/yr</div>
                    <div class="text-xs text-gray-500">üìÖ ${property['lodgement-date'] || 'N/A'}</div>
                    ${property['total-floor-area'] ? `<div class="text-xs text-gray-500">${property['total-floor-area']}m¬≤</div>` : ''}
                `;
            });
            
            if (results.length > 50) {
                const row = tbody.insertRow();
                row.insertCell().colSpan = 5;
                row.cells[0].className = 'text-center py-4 text-sm text-gray-600';
                row.cells[0].textContent = `Showing top 50 results. Export to CSV to see all ${results.length} properties.`;
            }
        }
        
        // Export CSV
        function exportCSV() {
            if (searchResults.length === 0) return;
            
            const headers = ['Lead Score', 'Address', 'Postcode', 'EPC Rating', 'Energy Efficiency', 
                           'Property Type', 'Built Form', 'Floor Area', 'Tenure', 'Heating Cost', 
                           'Certificate Date', 'Post Town', 'Rooms', 'Construction Age', 'LMK Key'];
            
            const csvData = searchResults.map(p => [
                p.leadScore || 0,
                [p.address1, p.address2, p.address3].filter(Boolean).join(' '),
                p.postcode || '',
                p['current-energy-rating'] || '',
                p['current-energy-efficiency'] || '',
                p['property-type'] || '',
                p['built-form'] || '',
                p['total-floor-area'] || '',
                p.tenure || '',
                p['heating-cost-current'] || '',
                p['lodgement-date'] || '',
                p.posttown || '',
                p['number-habitable-rooms'] || '',
                p['construction-age-band'] || '',
                p['lmk-key'] || ''
            ]);
            
            const csvContent = [headers, ...csvData]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `epc-leads-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }
        
        // Event listeners
        document.getElementById('searchBtn').addEventListener('click', search);
        document.getElementById('exportBtn').addEventListener('click', exportCSV);
        
        // Enter key support
        document.getElementById('searchTerm').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') search();
        });
    </script>
</body>
</html>